<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FossilFacil | Dashboard</title>

    <link rel="stylesheet" href="styles/dashboards.css">
    <link rel="icon" href="styles/assets/icone.png">
    <script src="js/sessao.js"></script>
    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<body>
    <div class="janela">
        <div class="header-left">
             <img src="styles/assets/logoFossilFacilSemFundo.png" alt="logoFossilFacil" style="width: 300px; height: auto;">

            <div class="hello">
                <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
            </div>

            <div class="botooes">

                <div class="btn-voltar btn-logout">
            
                    <a href="hub/index.html">
                        <h3>Voltar</h3>
                    </a>
                </div>
                
                <div class="btn-logout" onclick="limparSessao()">
                    <h3>Sair</h3>
                </div>
            </div>

        </div>

        <div class="dash">
            <h2>Seu desempenho no quiz</h2>
            <canvas id="graficoDonut" width="300" height="300"></canvas>

            <h2>Ranking dos melhores usuários</h2>
            <div id="ranking"></div>

        </div>
    </div>


</body>
</html>

<script>
    const idUsuario = sessionStorage.NOME_USUARIO;

    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    // Função para buscar dados da dashboard via API
    async function buscarDadosDashboard() {
      try {
        const response = await fetch(`/dashboard/dados/${idUsuario}`);
        console.log(`/dashboard/dados/${idUsuario}`)
        const data = await response.json();
        montarGraficoDonut(data.usuario.acertos, data.usuario.totalPerguntas);
        montarRanking(data.ranking);
      } catch (error) {
        console.error('Erro ao carregar dados da dashboard:', error);
      }
    }

    // Função para montar o gráfico donut com ChartJS
    function montarGraficoDonut(acertos, total) {
      const ctx = document.getElementById('graficoDonut').getContext('2d');
      const erros = total - acertos;

      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Acertos', 'Erros'],
          datasets: [{
            data: [acertos, erros],
            backgroundColor: ['#4caf50', '#f44336']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            title: {
              display: true,
              text: `Você acertou ${acertos} de ${total} perguntas`
            }
          },
          cutout: '60%'
        }
      });
    }

    // Função para montar o ranking na página
    function montarRanking(ranking) {
      const rankingDiv = document.getElementById('ranking');
      rankingDiv.innerHTML = ''; // limpa conteúdo anterior

      ranking.forEach((usuario, index) => {
        const div = document.createElement('div');
        div.textContent =` ${index + 1}º - ${usuario.nome}: ${usuario.acertos} pontos`;
        rankingDiv.appendChild(div);
      });
    }

    // Chama a função para carregar os dados assim que a página carregar
    window.onload = buscarDadosDashboard;
  </script>